<div class="container">
    <div class="left-section">
        <div class="input-group">
            <label for="title">Tên thư mục:</label>
            <input type="text" id="title" >

        </div>
        <div class="input-group">
            <label for="term">Môn học:</label>
            <input type="text" id="term" >

        </div>

        <div class="button-group">
            <button class="btn save">Lưu</button>
            <button class="btn cancel">Hủy</button>
        </div>
    </div>
    <div class="main-content">
        <div id="questions-container">
            {{#each questions}}
            <div class="question">
                <h3>câu hỏi</h3>
                <div class="content-question">
                    <label for="content-{{@index}}">Nội dung</label>
                    <input type="text" style = "height: 90px" id="content-{{@index}}" value="{{this.content}}" >
                </div>
                <div class="criteria">
                    <div class="criterion">
                        <label for="length-{{@index}}">Độ dài văn bản</label>
                        <input type="text" id="length-{{@index}}" class="criterion-input">
                    </div>
                    <div class="criterion">
                        <label for="phrase-{{@index}}">Cụm từ yêu cầu</label>
                        <input type="text" id="phrase-{{@index}}" class="criterion-input">
                    </div>
                </div>
                <button class="update-btn">Cập nhật</button>
                <button class="delete-question" style="background-color: #a9a9a9;">Xóa</button>
            </div>
            {{/each}}
        </div>
        <button class="question-add" id="add-question">+</button>
    </div>

</div>

<div id="confirmation-modal" class="modal">
    <div class="modal-content" style="justify-content: space-between; display: flex; align-items: center">
        <h4 style="color: #064050; text-align: center;">Xác nhận</h2>
        
        <hr style="height:2px;margin-top: 2px">

        <p style=" text-align: center; font-size: 20px">Bạn có chắc chắn muốn xóa?</p>
        <div class="row" style="margin-top: 15px">
            <div class="col">
                <button id="confirm-delete" style="width: 100px; ">Xác nhận</button>
            </div>
            <div class="col">
                <button id="cancel-delete" style="background-color: #a9a9a9;">Hủy</button>
            </div>
        </div>
        
        
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const questionsContainer = document.getElementById('questions-container');
    const addQuestionBtn = document.getElementById('add-question');
    const confirmationModal = document.getElementById('confirmation-modal');
    const notification = document.getElementById('notification');
    let currentDeleteTarget = null;

    function updateQuestionNumbers() {
        const questionCount = questionsContainer.children.length;
        let questionIndex = 1; // Bắt đầu từ 1

        // Duyệt qua từng thẻ <h3> trong questionsContainer
        for (const question of questionsContainer.querySelectorAll('.question h3')) {
            question.textContent = `Câu hỏi ${questionIndex}`;
            questionIndex++;
        }
    }

    updateQuestionNumbers();

    function showNotification(message) {
        notification.textContent = message;
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 1000);
    }

    function addQuestion() {
        const questionCount = questionsContainer.children.length + 1;
        const questionHtml = `
            <div class="question">
                <h3>Câu hỏi ${questionCount}</h3>  <!-- Thay đổi tiêu đề câu hỏi -->
                <div class="content-question">
                    <label for="content-${questionCount}">Nội dung</label>
                    <input type="text" id="content-${questionCount}" value="">
                </div>
                <div class="criteria">
                    <div class="criterion">
                        <label for="length-${questionCount}">Độ dài văn bản</label>
                        <input type="text" id="length-${questionCount}" class="criterion-input">
                    </div>
                    <div class="criterion">
                        <label for="phrase-${questionCount}">Cụm từ yêu cầu</label>
                        <input type="text" id="phrase-${questionCount}" class="criterion-input">
                    </div>
                </div>
                <button class="update-btn">Cập nhật</button>
                <button class="delete-question">Xóa</button>
            </div>
        `;
        updateQuestionNumbers();
        questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
    }

    function handleDelete(event) {
        if (event.target.classList.contains('delete-question')) {
            currentDeleteTarget = event.target.closest('.question');
            confirmationModal.style.display = 'flex';
        } else if (event.target.classList.contains('delete-criterion')) {
            currentDeleteTarget = event.target.closest('.criterion');
            confirmationModal.style.display = 'flex';
        }
    }

    function confirmDelete() {
        if (currentDeleteTarget) {
            const questionId = currentDeleteTarget.getAttribute('data-id');
            fetch(`/delete-question/${questionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentDeleteTarget.remove();
                    showNotification('Đã xóa thành công');
                } else {
                    showNotification('Xóa thất bại');
                }
            })
            .catch(error => {
                showNotification('Lỗi khi xóa');
            })
            .finally(() => {
                confirmationModal.style.display = 'none';
                currentDeleteTarget = null;
            });
        }
    }

    function cancelDelete() {
        confirmationModal.style.display = 'none';
        currentDeleteTarget = null;
    }

    function updateContent(event) {
        if (event.target.classList.contains('update-btn')) {
            const questionDiv = event.target.closest('.question');
            const contentInput = questionDiv.querySelector('.content input');
            const lengthInput = questionDiv.querySelector('.criterion-input[id^="length-"]');
            const phraseInput = questionDiv.querySelector('.criterion-input[id^="phrase-"]');
            const questionId = questionDiv.getAttribute('data-id');

            if (contentInput.value.trim()) {
                fetch(`/update-question/${questionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: contentInput.value,
                        length: lengthInput.value,
                        phrase: phraseInput.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Cập nhật thành công');
                    } else {
                        showNotification('Cập nhật thất bại');
                    }
                })
                .catch(error => {
                    showNotification('Lỗi khi cập nhật');
                });
            }
        }
    }

    addQuestionBtn.addEventListener('click', addQuestion);
    questionsContainer.addEventListener('click', handleDelete);
    questionsContainer.addEventListener('click', updateContent);

    document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
    document.getElementById('cancel-delete').addEventListener('click', cancelDelete);
});
</script>

